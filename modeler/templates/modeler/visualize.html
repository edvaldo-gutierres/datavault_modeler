{% extends "modeler/base.html" %}

{% block title %}Data Vault Model Visualization{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">Data Vault Model Visualization</h1>
    <p>This is a visual representation of your Data Vault model.</p>

    {% if error_message %}
        <div class="alert alert-danger" role="alert">
            <h4 class="alert-heading">Error!</h4>
            <p>Could not generate the model visualization.</p>
            <hr>
            <p class="mb-0"><strong>Details:</strong> {{ error_message }}</p>
        </div>
    {% else %}
        <div class="mermaid" id="mermaid-diagram" style="background-color: #1a1a1a; padding: 20px; border-radius: 8px;">
            {{ mermaid_data|safe }}
        </div>
        <button class="btn btn-primary mt-3" id="export-png">Exportar como PNG</button>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
    // Configuração do tema escuro do Mermaid
    mermaid.initialize({
        startOnLoad: true,
        theme: 'dark',
        er: {
            useMaxWidth: true,
            entityPadding: 40,
            fontSize: 18,
            fill: '#242424',
            stroke: '#666',
            minEntityWidth: 400,
            minEntityHeight: 150,
            entitySpacing: 50,
            edgeSpacing: 50,
            wrap: true,
            diagramPadding: 20
        },
        themeVariables: {
            darkMode: true,
            background: '#1a1a1a',
            mainBkg: '#242424',
            textColor: '#fff',
            lineColor: '#666',
            fontSize: '18px',
            fontFamily: 'monospace'
        }
    });

    document.getElementById('export-png')?.addEventListener('click', function() {
        const svgElem = document.querySelector('#mermaid-diagram svg');
        if (!svgElem) {
            alert('Diagrama não encontrado!');
            return;
        }
        const serializer = new XMLSerializer();
        const svgString = serializer.serializeToString(svgElem);
        const canvas = document.createElement('canvas');
        const bbox = svgElem.getBBox();
        canvas.width = bbox.width + 40;
        canvas.height = bbox.height + 40;
        const ctx = canvas.getContext('2d');
        const img = new Image();
        const svgBlob = new Blob([svgString], {type: 'image/svg+xml;charset=utf-8'});
        const url = URL.createObjectURL(svgBlob);
        img.onload = function() {
            ctx.fillStyle = '#1a1a1a';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 20, 20);
            URL.revokeObjectURL(url);
            const pngUrl = canvas.toDataURL('image/png');
            const a = document.createElement('a');
            a.href = pngUrl;
            a.download = 'datavault_diagram.png';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        };
        img.src = url;
    });

    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(function() {
            // Definição das cores para tema escuro
            const colorScheme = {
                hub: {
                    border: '#60a5fa',      // Azul claro
                },
                link: {
                    border: '#fb923c',      // Laranja claro
                },
                satellite: {
                    border: '#facc15',      // Amarelo claro
                }
            };

            // Função para obter o tipo de entidade
            function getEntityType(name) {
                if (name.startsWith('H_')) return 'hub';
                if (name.startsWith('L_')) return 'link';
                if (name.startsWith('S_')) return 'satellite';
                return null;
            }

            // Colorir entidades
            document.querySelectorAll('.mermaid svg g').forEach(function(g) {
                const label = g.querySelector('text');
                if (!label) return;
                
                const name = label.textContent.trim();
                const entityType = getEntityType(name);
                if (!entityType) return;
                
                const colors = colorScheme[entityType];

                // Aplica cores às bordas
                g.querySelectorAll('rect').forEach(function(rect) {
                    rect.setAttribute('stroke', colors.border);
                    rect.setAttribute('stroke-width', '2');
                });

                // Aplica cores às linhas de grade internas
                g.querySelectorAll('line').forEach(function(line) {
                    line.setAttribute('stroke', colors.border);
                });
                
                // Aplica cor ao texto
                g.querySelectorAll('text').forEach(function(text) {
                    text.setAttribute('fill', colors.border);
                    text.style.fontSize = '14px';
                });
            });

            // Colorir relacionamentos
            document.querySelectorAll('.mermaid svg path').forEach(function(path) {
                const relationshipText = path.parentElement.querySelector('text');
                if (!relationshipText) return;

                const text = relationshipText.textContent.trim();
                if (text.includes('connects')) {
                    path.setAttribute('stroke', colorScheme.link.border);
                    path.setAttribute('marker-end', `url(#arrowhead-${colorScheme.link.border.substring(1)})`);
                    relationshipText.setAttribute('fill', colorScheme.link.border);
                } else if (text.includes('describes')) {
                    path.setAttribute('stroke', colorScheme.satellite.border);
                    path.setAttribute('marker-end', `url(#arrowhead-${colorScheme.satellite.border.substring(1)})`);
                    relationshipText.setAttribute('fill', colorScheme.satellite.border);
                }
            });

            // Criar marcadores de seta personalizados para cada cor
            const defs = document.querySelector('.mermaid svg defs');
            if (defs) {
                Object.values(colorScheme).forEach(colors => {
                    const marker = document.createElementNS('http://www.w3.org/2000/svg', 'marker');
                    const colorCode = colors.border.substring(1);
                    marker.setAttribute('id', `arrowhead-${colorCode}`);
                    marker.setAttribute('viewBox', '0 0 10 10');
                    marker.setAttribute('refX', '9');
                    marker.setAttribute('refY', '5');
                    marker.setAttribute('markerWidth', '6');
                    marker.setAttribute('markerHeight', '6');
                    marker.setAttribute('orient', 'auto');
                    
                    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    path.setAttribute('d', 'M 0 0 L 10 5 L 0 10 z');
                    path.setAttribute('fill', colors.border);
                    
                    marker.appendChild(path);
                    defs.appendChild(marker);
                });
            }
        }, 500);
    });
</script>
{% endblock %} 