{% extends "modeler/base.html" %}

{% block title %}Data Vault Model Visualization{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">Data Vault Model Visualization</h1>
    <p>This is a visual representation of your Data Vault model.</p>

    {% if error_message %}
        <div class="alert alert-danger" role="alert">
            <h4 class="alert-heading">Error!</h4>
            <p>Could not generate the model visualization.</p>
            <hr>
            <p class="mb-0"><strong>Details:</strong> {{ error_message }}</p>
        </div>
    {% else %}
        <div class="mermaid" id="mermaid-diagram">
            {{ mermaid_data|safe }}
        </div>
        <button class="btn btn-primary mt-3" id="export-png">Exportar como PNG</button>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
    document.getElementById('export-png')?.addEventListener('click', function() {
        const svgElem = document.querySelector('#mermaid-diagram svg');
        if (!svgElem) {
            alert('Diagrama n√£o encontrado!');
            return;
        }
        const serializer = new XMLSerializer();
        const svgString = serializer.serializeToString(svgElem);
        const canvas = document.createElement('canvas');
        const bbox = svgElem.getBBox();
        canvas.width = bbox.width + 20;
        canvas.height = bbox.height + 20;
        const ctx = canvas.getContext('2d');
        const img = new Image();
        const svgBlob = new Blob([svgString], {type: 'image/svg+xml;charset=utf-8'});
        const url = URL.createObjectURL(svgBlob);
        img.onload = function() {
            ctx.fillStyle = '#fff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 10, 10);
            URL.revokeObjectURL(url);
            const pngUrl = canvas.toDataURL('image/png');
            const a = document.createElement('a');
            a.href = pngUrl;
            a.download = 'datavault_diagram.png';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        };
        img.src = url;
    });
</script>
{% endblock %} 